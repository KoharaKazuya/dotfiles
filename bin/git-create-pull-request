#!/bin/sh

set -eu

current=$(git current-branch)

head=""
origin_url=$(git remote get-url --push origin 2>/dev/null || :)
upstream_url=$(git remote get-url upstream 2>/dev/null || :)
if [ -n "$origin_url" ] && [ -n "$upstream_url" ]; then
  git push origin
  if [ "${origin_url%/*/*}" = "${upstream_url%/*/*}" ] && [ "${origin_url##*/}" = "${upstream_url##*/}" ]; then
    origin_owner="${origin_url%/*}"
    head="${origin_owner##*/}:$current"
  fi
fi

latest_time=""
latest_branch=""
# 全リモートブランチのうち、
for branch in $(git show-ref | grep refs/remotes/upstream | cut -d/ -f3-); do
  if [ ${branch#*/} = $current ]; then continue; fi
  # 共通祖先コミット
  base=$(git merge-base $current $branch)
  # 共通祖先コミットの Author Date
  d=$(git show --no-patch --pretty='format:%at' $base)
  # 最新のコミットを探す
  if [ -z "$latest_time" ] || [ $d -gt $latest_time ]; then
    latest_time=$d
    latest_branch=$branch
  fi
done

options=""
if [ -n "$head" ]; then options="$options --head $head"; fi
if [ -n "$latest_branch" ]; then options="$options --base ${latest_branch#*/}"; fi

gh pr create --web $options
