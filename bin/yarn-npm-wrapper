#!/bin/bash

set -eu

if [ $# = 0 ]; then
  exec npm
fi

raw_args=()

# parse subcommand
subcommand=""
case "$1" in
    i | install ) subcommand='install';;
    *           ) exec npm "$@";;
esac
raw_args+=( "$1" )
shift

# parse packages and options
packages=()
deps=''
while [ $# -gt 0 ]; do
    case "$1" in
        -S | --save     ) if [ "$subcommand" = 'install' ]; then subcommand='add'; fi;;
        -D | --save-dev ) if [ "$subcommand" = 'install' ]; then subcommand='add'; fi
                          deps='--dev';;
        -*              ) exec npm "${raw_args[@]}" "$@";;
        *               ) packages+=( "$1" );;
    esac
    raw_args+=( "$1" )
    shift
done

yarn_options="--pure-lockfile"
if [ ${#packages[@]} -gt 0 ]; then
  if [ "$subcommand" = 'install' ]; then
    exec npm "${raw_args[@]}"
  fi
  exec yarn $subcommand $yarn_options $deps ${packages[@]}
else
  exec yarn $subcommand $yarn_options $deps
fi
